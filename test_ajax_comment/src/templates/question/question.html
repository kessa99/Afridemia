{% extends 'base/base.html' %}

{% block title %}Cr√©er un sondage{% endblock %}

{% block content %}


<div class="poll-area">
    <input type="checkbox" name="poll" id="opt-1">
    <input type="checkbox" name="poll" id="opt-2">
    <input type="checkbox" name="poll" id="opt-3">
    <input type="checkbox" name="poll" id="opt-4">

    {% for answer in question.answers.all %}
    <label for="opt-{{forloop.counter}}" data-answer="{{answer.uid}}" class="opt-{{forloop.counter}} border border-gray-300 p-3 rounded-md hover:border-gray-400 transition">
        <div class="flex justify-between items-center">
            <div class="flex items-center">
                <span class="circle border-2 border-gray-300 h-4 w-4 rounded-full mr-2"></span>
                <span class="text">{{answer.answer_text}}</span>
            </div>
            <span class="percent hidden">30%</span>
        </div>
        <div class="progress h-2 w-full bg-gray-300 mt-2 rounded-full hidden"></div>
    </label>
    {% endfor %}
</div>
<script>
    async function call_api(question_uid, answer_uid) {
        console.log('Api called')
         const rawResponse = await fetch('/api/save_question_result/', {
             method: 'POST',
             headers: {
                 'Accept': 'application/json',
                 'Content-Type': 'application/json',
                 "X-CSRFToken": '{{ csrf_token }}'
             },
             body: JSON.stringify({
                 csrfmiddlewaretoken: '{{ csrf_token }}' ,
                 question_uid: question_uid,
                 answer_uid: answer_uid
             })
         }).then(result => result.json())
         .then(data => {
             console.log(data)

             var elements = document.querySelectorAll('.percent')
             var progres = document.querySelectorAll('.progress')
            for(var i =0;i<elements.length;i++){
                elements[i].textContent = data.data[i] + '%'
                progres[i].style = `--w:${data.data[i]};`

            }
         })
         // const content = await rawResponse.json();

         // console.log(content);

     }


     const options = document.querySelectorAll("label");
     var answer_uid = null
     var question_uid = "{{question.uid}}"
     for (let i = 0; i < options.length; i++) {
         options[i].addEventListener("click", () => {
             for (let j = 0; j < options.length; j++) {
                 //console.log("Event added")
                 answer_uid = options[i].dataset.answer
                 // console.log(answer_uid)
                 if (options[j].classList.contains("selected")) {
                     options[j].classList.remove("selected");
                 }
             }

             options[i].classList.add("selected");
             for (let k = 0; k < options.length; k++) {
                 options[k].classList.add("selectall");
             }

             let forVal = options[i].getAttribute("for");
             let selectInput = document.querySelector("#" + forVal);
             let getAtt = selectInput.getAttribute("type");
             if (getAtt == "checkbox") {
                 selectInput.setAttribute("type", "radio");
             } else if (selectInput.checked == true) {
                 options[i].classList.remove("selected");
                 selectInput.setAttribute("type", "checkbox");
             }

             let array = [];
             for (let l = 0; l < options.length; l++) {
                 if (options[l].classList.contains("selected")) {
                     array.push(l);
                 }
             }
             if (array.length == 0) {
                 for (let m = 0; m < options.length; m++) {
                     options[m].removeAttribute("class");
                 }
             }
             call_api(question_uid , answer_uid)
             console.log(answer_uid)
         });
     }
 </script>


{% endblock %}
